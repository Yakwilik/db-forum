# First stage: GoLang
FROM golang:1.20.4-alpine as builder
WORKDIR /app
COPY . .
RUN go mod download
RUN go build -o app cmd/db-forum/main.go

# Final stage
FROM postgres:13-alpine
COPY --from=builder /app/main /app/main
COPY --from=builder /app/db/db.sql /docker-entrypoint-initdb.d/

# Install the `supervisord`
RUN apk add --no-cache supervisor

# Create directory for supervisor logs
RUN mkdir -p /var/log/supervisor

# Copy supervisor configuration
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Expose default postgres port and app port
EXPOSE 5432
EXPOSE 5000

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
